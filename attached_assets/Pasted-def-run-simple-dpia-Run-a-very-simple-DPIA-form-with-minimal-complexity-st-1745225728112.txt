def run_simple_dpia():
    """Run a very simple DPIA form with minimal complexity."""
    
    st.title("DPIA Assessment")

    if st.checkbox("Debug: Show Session State", value=False, key="debug_show_session"):
        st.write(dict((k, v) for k, v in st.session_state.items() if not k.startswith('_')))

    if st.checkbox("Debug: Reset Form", value=False, key="debug_reset_form"):
        for key in list(st.session_state.keys()):
            if key.startswith('simple_dpia') or key in ['assessment_results', 'report_data', 'display_results']:
                del st.session_state[key]
        st.success("Form state reset")
        st.rerun()

    try:
        scanner = DPIAScanner(language='en')
        assessment_categories = scanner._get_assessment_categories()
    except Exception as e:
        st.error(f"Error initializing DPIA scanner: {str(e)}")
        st.code(traceback.format_exc())
        return

    if 'simple_dpia_answers' not in st.session_state:
        st.session_state.simple_dpia_answers = {}

    # Ensure answers are correctly initialized or updated
    for category, meta in assessment_categories.items():
        question_count = len(meta.get('questions', []))
        prev_answers = st.session_state.simple_dpia_answers.get(category, [])
        st.session_state.simple_dpia_answers[category] = [
            prev_answers[i] if i < len(prev_answers) and isinstance(prev_answers[i], int) and 0 <= prev_answers[i] <= 2 else 0
            for i in range(question_count)
        ]

    st.info("This is a simplified DPIA assessment form. Please answer all questions and click Submit.")

    if 'display_results' in st.session_state and st.session_state.display_results and 'assessment_results' in st.session_state:
        try:
            display_assessment_results(
                st.session_state.assessment_results,
                st.session_state.report_data,
                scanner
            )

            if st.button("Start New Assessment", type="primary"):
                for key in ['simple_dpia_answers', 'assessment_results', 'report_data', 'display_results']:
                    if key in st.session_state:
                        del st.session_state[key]
                st.rerun()
            return
        except Exception as e:
            st.error(f"Error displaying results: {str(e)}")
            st.exception(e)

    st.subheader("Assessment Questions")

    tab_labels = [assessment_categories[cat]['name'] for cat in assessment_categories]
    tabs = st.tabs(tab_labels)

    for i, category in enumerate(assessment_categories):
        with tabs[i]:
            st.markdown(f"### {assessment_categories[category]['name']}")
            st.markdown(f"*{assessment_categories[category]['description']}*")
            st.markdown("---")

            for q_idx, question_text in enumerate(assessment_categories[category]['questions']):
                st.markdown(f"**{question_text}**")

                options = ["No", "Partially", "Yes"]
                stored_value = st.session_state.simple_dpia_answers[category][q_idx]

                # Safe index
                index = stored_value if isinstance(stored_value, int) and 0 <= stored_value < len(options) else 0

                answer = st.radio(
                    "Answer:",
                    options,
                    index=index,
                    key=f"radio_{category}_{q_idx}",
                    horizontal=True,
                    label_visibility="collapsed"
                )

                st.session_state.simple_dpia_answers[category][q_idx] = options.index(answer)
                st.markdown("---")

    if st.button("Submit Assessment", type="primary", use_container_width=True):
        with st.spinner("Processing assessment..."):
            try:
                answers = {
                    category: list(values)
                    for category, values in st.session_state.simple_dpia_answers.items()
                }

                st.write("Processing the following answers:")
                st.write(f"**Answer structure:** {json.dumps(answers, indent=2)}")
                st.write("Calculating scores...")

                total_score = 0
                high_risk_count = 0
                medium_risk_count = 0
                low_risk_count = 0
                total_questions = 0
                category_scores = {}

                for category, answer_values in answers.items():
                    category_score = sum(answer_values)
                    max_possible = len(answer_values) * 2
                    percentage = (category_score / max_possible) * 10

                    if percentage >= 7:
                        risk_level = "High"
                        high_risk_count += 1
                    elif percentage >= 4:
                        risk_level = "Medium"
                        medium_risk_count += 1
                    else:
                        risk_level = "Low"
                        low_risk_count += 1

                    category_scores[category] = {
                        "score": category_score,
                        "max_possible": max_possible,
                        "percentage": percentage,
                        "risk_level": risk_level
                    }

                    total_score += category_score
                    total_questions += len(answer_values)

                max_total = total_questions * 2
                overall_percentage = (total_score / max_total) * 10 if max_total > 0 else 0

                if overall_percentage >= 7:
                    overall_risk = "High"
                elif overall_percentage >= 4:
                    overall_risk = "Medium"
                else:
                    overall_risk = "Low"

                st.write(f"Our calculation - Overall Risk: {overall_risk}, Score: {overall_percentage:.1f}/10")

                st.write("Calling official scanner...")
                assessment_results = scanner.perform_assessment(answers=answers)

                scan_id = str(uuid.uuid4())
                timestamp = datetime.now().isoformat()

                if 'scan_id' not in assessment_results:
                    assessment_results['scan_id'] = scan_id
                if 'timestamp' not in assessment_results:
                    assessment_results['timestamp'] = timestamp

                st.write(f"Scanner result - Overall Risk: {assessment_results['overall_risk_level']}, Score: {assessment_results['overall_percentage']:.1f}/10")

                st.write("Generating report data...")
                report_data = generate_dpia_report(assessment_results)

                st.write("Saving results to session state...")
                st.session_state.assessment_results = assessment_results
                st.session_state.report_data = report_data
                st.session_state.display_results = True

                st.success("Assessment completed successfully! Click Continue to view results.")
                if st.button("Continue to Results", type="primary"):
                    st.rerun()

            except Exception as e:
                st.error(f"Error performing assessment: {str(e)}")
                st.write("Exception details:")
                st.code(traceback.format_exc())
