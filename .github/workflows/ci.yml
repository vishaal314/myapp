name: DataGuardian Pro CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  lint_and_test:
    name: Lint and Test
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.11'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest pytest-cov
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics
    
    - name: Test with pytest
      run: |
        if [ -d tests ]; then
          pytest --cov=./ --cov-report=xml
        else
          echo "No tests directory found, skipping tests"
        fi
      env:
        DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
    
    - name: Upload coverage report
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        fail_ci_if_error: false

  security_scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint_and_test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Run Bandit security scanner
      run: |
        pip install bandit
        bandit -r . -x ./tests,./.venv,./venv --format json -o bandit-results.json || true
    
    - name: Upload security scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: bandit-results.json
        category: bandit
      if: always()
    
    - name: Check for sensitive data exposure
      uses: zricethezav/gitleaks-action@master
      with:
        config-path: .github/gitleaks.toml
      if: github.event_name == 'pull_request'
      continue-on-error: true

  build_and_push:
    name: Build and Push
    runs-on: ubuntu-latest
    needs: [lint_and_test, security_scan]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          dataguardianpro/app:${{ github.sha }}
          dataguardianpro/app:latest
        cache-from: type=registry,ref=dataguardianpro/app:latest
        cache-to: type=inline
    
    - name: Generate deployment package
      run: |
        zip -r deploy.zip . -x "*.git*" "venv/*" "__pycache__/*" "*.pyc" "node_modules/*"
    
    - name: Upload deployment package
      uses: actions/upload-artifact@v3
      with:
        name: deploy-package
        path: deploy.zip
        retention-days: 7

  deploy_staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build_and_push
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging
    
    steps:
    - name: Download deployment package
      uses: actions/download-artifact@v3
      with:
        name: deploy-package
    
    - name: Unzip deployment package
      run: unzip -q deploy.zip
    
    - name: Deploy to Staging
      uses: easingthemes/ssh-deploy@main
      env:
        SSH_PRIVATE_KEY: ${{ secrets.STAGING_SSH_KEY }}
        ARGS: "-avz --delete"
        SOURCE: "./"
        REMOTE_HOST: ${{ secrets.STAGING_HOST }}
        REMOTE_USER: ${{ secrets.STAGING_USER }}
        TARGET: ${{ secrets.STAGING_PATH }}
        EXCLUDE: "/.git/, /venv/, /__pycache__/, /.github/"
    
    - name: Execute remote deployment script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script: |
          cd ${{ secrets.STAGING_PATH }}
          ./deploy.sh

  deploy_production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build_and_push
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production
    
    steps:
    - name: Download deployment package
      uses: actions/download-artifact@v3
      with:
        name: deploy-package
    
    - name: Unzip deployment package
      run: unzip -q deploy.zip
    
    - name: Deploy to Production
      uses: easingthemes/ssh-deploy@main
      env:
        SSH_PRIVATE_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}
        ARGS: "-avz --delete"
        SOURCE: "./"
        REMOTE_HOST: ${{ secrets.PRODUCTION_HOST }}
        REMOTE_USER: ${{ secrets.PRODUCTION_USER }}
        TARGET: ${{ secrets.PRODUCTION_PATH }}
        EXCLUDE: "/.git/, /venv/, /__pycache__/, /.github/"
    
    - name: Execute remote deployment script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          cd ${{ secrets.PRODUCTION_PATH }}
          ./deploy.sh