 ./complete_e2e_domain_https_fix.sh
ğŸš€ COMPLETE E2E DOMAIN HTTPS FIX
===============================
Comprehensive fix for dataguardianpro.nl with complete testing suite

ğŸ”§ PART 1: Environment setup and prerequisites
=============================================
âœ… Running as root
âœ… DataGuardian Pro found at: /opt/dataguardian
ğŸ“¦ Installing required packages...
âœ… Required packages installed
ğŸš€ Starting comprehensive E2E domain HTTPS fix...

ğŸŒ DNS VERIFICATION WITH BLOCKING
===============================
ğŸ” Testing DNS resolution for dataguardianpro.nl...
â° Will wait up to 300 seconds for DNS propagation

ğŸ§ª DNS Test Attempt 1/10:
   dig A record: 45.81.35.202
   dig any record: 45.81.35.202
   nslookup result: 45.81.35.202
âœ… DNS Resolution: SUCCESS! dataguardianpro.nl â†’ 45.81.35.202
ğŸ§ª Testing www subdomain...
âœ… www.dataguardianpro.nl â†’ 45.81.35.202 (Perfect!)
âœ… DNS verification completed successfully

ğŸŒ NGINX CONFIGURATION WITH RATE LIMITING FIX
==============================================
ğŸ›‘ Stopping Nginx for reconfiguration...
ğŸ“ Creating rate limiting configuration...
âœ… Rate limiting configuration created
ğŸ“ Creating correct Nginx configuration for dataguardianpro.nl...
âœ… Nginx configuration created
ğŸ§ª Testing Nginx configuration...
âœ… Nginx configuration: VALID

ğŸ” SERVICE VERIFICATION
====================
ğŸ“Š Checking DataGuardian service...
âœ… DataGuardian service: RUNNING
ğŸ§ª Testing local app connectivity...
âœ… Local app (port 5000): 200
ğŸ“Š Checking Nginx service...
âŒ Nginx service: NOT RUNNING
ğŸ”§ Starting Nginx service...
âœ… Nginx service: NOW RUNNING
ğŸ”Œ Checking port connectivity...
âœ… Port 5000: LISTENING
âœ… Port 80: LISTENING
âœ… All services verification: PASSED

ğŸ”¥ FIREWALL CONFIGURATION
=======================
âœ… Firewall configured

ğŸ” SSL CERTIFICATE PHASE
======================

ğŸ” SSL CERTIFICATE SETUP
=======================
ğŸ”§ Preparing for SSL certificate request...
ğŸ“‹ Requesting SSL certificate for dataguardianpro.nl and www.dataguardianpro.nl...
âŒ SSL certificate: FAILED TO OBTAIN
ğŸ” Certbot error log:
certbot.errors.MissingCommandlineFlag: Missing command line flag or config entry for this setting:
You have an existing certificate that contains a portion of the domains you requested (ref: /etc/letsencrypt/renewal/dataguardianpro.nl.conf)

It contains these names: dataguardianpro.nl

You requested these names for the new certificate: dataguardianpro.nl, www.dataguardianpro.nl.

Do you want to expand and replace this existing certificate with the new certificate?

(You can set this with the --expand flag)
2025-09-27 22:31:29,409:ERROR:certbot._internal.log:Missing command line flag or config entry for this setting:
You have an existing certificate that contains a portion of the domains you requested (ref: /etc/letsencrypt/renewal/dataguardianpro.nl.conf)

It contains these names: dataguardianpro.nl

You requested these names for the new certificate: dataguardianpro.nl, www.dataguardianpro.nl.

Do you want to expand and replace this existing certificate with the new certificate?

(You can set this with the --expand flag)
âš ï¸  SSL certificate setup failed - continuing with HTTP

ğŸ”„ FINAL SERVICE RESTART
======================

ğŸ§ª COMPREHENSIVE E2E TESTING SUITE
=================================
ğŸ” Running comprehensive test suite...

ğŸ“Š TEST SUITE 1: Service Status
==============================
âœ… TEST 1.1: DataGuardian service running
âœ… TEST 1.2: Nginx service running
âœ… TEST 1.3: Redis service running

ğŸ”Œ TEST SUITE 2: Port Connectivity
===============================
âœ… TEST 2.1: Port 5000 listening
âœ… TEST 2.2: Port 80 listening
âš ï¸  TEST 2.3: Port 443 not listening (no SSL)

ğŸŒ TEST SUITE 3: HTTP Connectivity
===============================
âœ… TEST 3.1: Local Streamlit (5000): 200
âœ… TEST 3.2: Local Nginx (80): 200
âœ… TEST 3.3: Domain HTTP: 200

ğŸ” TEST SUITE 4: HTTPS Connectivity
===============================
âŒ TEST 4.1: Domain HTTPS: 000000
âŒ TEST 4.2: WWW HTTPS: 000000

ğŸ TEST SUITE 5: App Functionality
==============================
âœ… TEST 5.1: App.py import working
âœ… TEST 5.2: App content detection (1 elements found)

ğŸŒ TEST SUITE 6: DNS Resolution
============================
âœ… TEST 6.1: DNS A record: dataguardianpro.nl â†’ 45.81.35.202
âœ… TEST 6.2: DNS www record: www.dataguardianpro.nl â†’ 45.81.35.202

ğŸ” TEST SUITE 7: SSL Certificate
============================
âœ… TEST 7.1: SSL certificate domain validation
â„¹ï¸  TEST 7.2: SSL certificate expires: Dec  9 22:01:47 2025 GMT

ğŸ“Š TEST RESULTS SUMMARY
======================
âœ… PASS: DataGuardian service
âœ… PASS: Nginx service
âœ… PASS: Redis service
âœ… PASS: Port 5000
âœ… PASS: Port 80
âš ï¸  WARN: Port 443
âœ… PASS: Local Streamlit
âœ… PASS: Local Nginx
âœ… PASS: Domain HTTP
âŒ FAIL: Domain HTTPS
âŒ FAIL: WWW HTTPS
âœ… PASS: App.py import
âœ… PASS: App content
âœ… PASS: DNS A record
âœ… PASS: DNS www record
âœ… PASS: SSL cert domain
â„¹ï¸  INFO: SSL expiry Dec  9 22:01:47 2025 GMT

âš ï¸  SOME TESTS FAILED - See summary above

âš ï¸  Some tests failed - see detailed results above

ğŸ“Š COMPLETE E2E DOMAIN HTTPS FIX - FINAL STATUS
==============================================

âœ… PARTIAL SUCCESS - HTTP WORKING
===============================

âœ… DNS: Working
âœ… Nginx: Fixed and working
âœ… HTTP: Fully functional
âš ï¸  SSL: Certificate setup failed

ğŸŒ CURRENT ACCESS:
   ğŸ“ HTTP: http://dataguardianpro.nl
   ğŸ“ Direct: http://45.81.35.202:5000

ğŸ”§ FOR HTTPS:
   Run: certbot --nginx -d dataguardianpro.nl -d www.dataguardianpro.nl

ğŸ“‹ CONFIGURATION SUMMARY:
=========================
   ğŸŒ Domain: dataguardianpro.nl
   ğŸ“ Server IP: 45.81.35.202
   ğŸ“‚ Installation: /opt/dataguardian
   ğŸŒ Web Server: Nginx (rate limiting fixed)
   ğŸ” SSL: Let's Encrypt
   ğŸ–¥ï¸  Service: systemctl status dataguardian

ğŸ¯ MANAGEMENT COMMANDS:
======================
   ğŸ”„ Restart all: systemctl restart dataguardian nginx
   ğŸ“Š Check status: systemctl status dataguardian nginx
   ğŸ“„ View logs: journalctl -u dataguardian -f
   ğŸ§ª Test again: curl http://dataguardianpro.nl

âœ… COMPLETE E2E DOMAIN HTTPS FIX COMPLETED!
All issues addressed with comprehensive testing suite